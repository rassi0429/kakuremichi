FROM golang:1.23-alpine AS builder

RUN apk add --no-cache git

WORKDIR /build

# Copy go mod files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build
RUN CGO_ENABLED=0 GOOS=linux go build -o gateway ./cmd/gateway

# Final stage
FROM alpine:latest

RUN apk add --no-cache iptables wireguard-tools

WORKDIR /app

COPY --from=builder /build/gateway .

# Create TUN device
RUN mkdir -p /dev/net/tun && \
    mknod /dev/net/tun c 10 200 || true

CMD ["/app/gateway"]
